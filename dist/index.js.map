{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import * as request from 'request';\nimport * as _ from 'lodash';\nimport {Logger} from './lib/Logger';\nconst logger = new Logger();\nconst flowUrl = 'https://api.flowdock.com/messages';\nconst DEFAULT_WARNING_THRESHOLD = 85;\nconst DEFAULT_FAILURE_THRESHOLD = 75;\n\nconst REQUIRED = ['token', 'author', 'threadId', 'threadTitle'];\n\n/*\n {\n   token: '<TOKEN>',\n   author: {\n     name: 'Sweeney Jenkins',\n     avatar: 'https://github.build.ge.com/avatars/u/23999?s=466',\n     email: 'Service.SweeneyJenkins@ge.com'\n   },\n   threadId: 'cr-it-results',\n   threadTitle: 'Config Reviewer IT Results',\n   resultsUrl: http://whatever.com,\n   warningThreshold: 85,\n   failureThreshold: 75\n }\n */\nexport class BusybeeFlowdock {\n  private conf: any;\n  private warningThreshold: number;\n  private failureThreshold: number;\n\n  constructor(conf) {\n    this.conf = conf;\n    this.warningThreshold = conf.warningThreshold || DEFAULT_WARNING_THRESHOLD;\n    this.failureThreshold = conf.failureThreshold || DEFAULT_FAILURE_THRESHOLD;\n\n    let failures = [];\n    REQUIRED.forEach(key => {\n      if (!conf[key]) {\n        failures.push(key);\n      }\n    });\n\n    if (failures.length > 0) {\n      if (failures.length === 1) {\n        throw  new Error(`'${failures[0]}' is a required configuration key`);\n      } else {\n        throw new Error(`'${failures.join(',')}' are required configuration keys`);\n      }\n    }\n  }\n\n  run(testSuiteResults: any) {\n    let restSuites = _.filter(testSuiteResults, ts => { return ts.type === 'REST'; });\n\n    let body = ''; // full Flowdock message body\n    let globalCount = 0;\n    let globalPass = 0;\n    restSuites.forEach(testSuite => {\n      let count = 0; // total tests in testSuite\n      let pass = 0; // total pass for testSuite\n      testSuite.testSets.forEach(testSet => {\n        testSet.tests.forEach(t => {\n          count += 1;\n          if (t.pass) {\n            pass += 1;\n          }\n        });\n      });\n\n      // build summary message for this testSuite\n      let score = Math.round(pass / count * 100);\n      let color = this.determineStatusColor(score);\n      body += `<span style='color:${color};'>${testSuite.id} Complete With ${score}% Passing</span><br/>`\n      globalCount += count;\n      globalPass += globalPass;\n    });\n\n    // summarize the complete results and create the message title\n    let statusValue = 'PASSED';\n    let globalScore = Math.round(globalPass / globalCount * 100);\n    let statusColor = this.determineStatusColor(globalScore);\n    if (statusColor == 'yellow') {\n      statusValue = 'UNSTABLE';\n    } else if (statusColor == 'red') {\n      statusValue = 'FAILING';\n    }\n\n    let payload = {\n      author: this.conf.author,\n      flow_token: this.conf.token,\n      event: 'activity',\n      title: `${globalPass}/${globalCount} (${globalScore}%) Passing`,\n      body: body,\n      external_thread_id: this.conf.threadId,\n      thread: {\n        title: this.conf.threadTitle,\n        status: {\n          color: statusColor,\n          value: statusValue\n        }\n      }\n    }\n\n    if (this.conf.resultsUrl) {\n        payload.body = `<a href='${this.conf.resultsUrl}'>${payload.body}</a>`;\n    }\n\n    try {\n      this.send(payload);\n    } catch (e) {\n      logger.error(e.message);\n      throw new Error(`Error publishing test results to Flowdock`);\n    }\n\n  }\n\n  send(payload) {\n    logger.debug(`sending to flowdock`);\n    logger.debug(payload);\n    request.post({url: flowUrl, body: payload, json: true});\n  }\n\n  determineStatusColor(score) {\n    let statusColor = 'green';\n    if (score < this.warningThreshold) {\n      if (score < this.failureThreshold) {\n        statusColor = 'red';\n      } else {\n        statusColor = 'yellow';\n      }\n    }\n\n    return statusColor;\n  }\n}\n"]}